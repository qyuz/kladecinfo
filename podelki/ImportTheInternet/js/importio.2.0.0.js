/*
 * Copyright (c) 2010 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */typeof dojo!="undefined"?dojo.provide("org.cometd"):(this.org=this.org||{},org.cometd={}),org.cometd.JSON={},org.cometd.JSON.toJSON=org.cometd.JSON.fromJSON=function(e){throw"Abstract"},org.cometd.Utils={},org.cometd.Utils.isString=function(e){return e===undefined||e===null?!1:typeof e=="string"||e instanceof String},org.cometd.Utils.isArray=function(e){return e===undefined||e===null?!1:e instanceof Array},org.cometd.Utils.inArray=function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1},org.cometd.Utils.setTimeout=function(e,t,n){return window.setTimeout(function(){try{t()}catch(n){e._debug("Exception invoking timed function",t,n)}},n)},org.cometd.Utils.clearTimeout=function(e){window.clearTimeout(e)},org.cometd.TransportRegistry=function(){var e=[],t={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(n,r,i){var s=[];for(var o=0;o<e.length;++o){var u=e[o];t[u].accept(n,r,i)===!0&&s.push(u)}return s},this.negotiateTransport=function(n,r,i,s){for(var o=0;o<e.length;++o){var u=e[o];for(var a=0;a<n.length;++a)if(u===n[a]){var f=t[u];if(f.accept(r,i,s)===!0)return f}}return null},this.add=function(n,r,i){var s=!1;for(var o=0;o<e.length;++o)if(e[o]===n){s=!0;break}return s||(typeof i!="number"?e.push(n):e.splice(i,0,n),t[n]=r),!s},this.find=function(n){for(var r=0;r<e.length;++r)if(e[r]===n)return t[n];return null},this.remove=function(n){for(var r=0;r<e.length;++r)if(e[r]===n){e.splice(r,1);var i=t[n];return delete t[n],i}return null},this.clear=function(){e=[],t={}},this.reset=function(){for(var n=0;n<e.length;++n)t[e[n]].reset()}},org.cometd.Transport=function(){var e,t;this.registered=function(n,r){e=n,t=r},this.unregistered=function(){e=null,t=null},this._debug=function(){t._debug.apply(t,arguments)},this._mixin=function(){return t._mixin.apply(t,arguments)},this.getConfiguration=function(){return t.getConfiguration()},this.getAdvice=function(){return t.getAdvice()},this.setTimeout=function(e,n){return org.cometd.Utils.setTimeout(t,e,n)},this.clearTimeout=function(e){org.cometd.Utils.clearTimeout(e)},this.convertToMessages=function(e){if(org.cometd.Utils.isString(e))try{return org.cometd.JSON.fromJSON(e)}catch(t){throw this._debug("Could not convert to JSON the following string",'"'+e+'"'),t}if(org.cometd.Utils.isArray(e))return e;if(e===undefined||e===null)return[];if(e instanceof Object)return[e];throw"Conversion Error "+e+", typeof "+typeof e},this.accept=function(e,t,n){throw"Abstract"},this.getType=function(){return e},this.send=function(e,t){throw"Abstract"},this.reset=function(){this._debug("Transport",e,"reset")},this.abort=function(){this._debug("Transport",e,"aborted")},this.toString=function(){return this.getType()}},org.cometd.Transport.derive=function(e){function t(){}return t.prototype=e,new t},org.cometd.RequestTransport=function(){function o(e){while(s.length>0){var t=s[0],n=t[0],r=t[1];if(n.url===e.url&&n.sync===e.sync){s.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",r.id);continue}break}}function u(e,t){this.transportSend(e,t),t.expired=!1;if(!e.sync){var n=this.getConfiguration().maxNetworkDelay,r=n;t.metaConnect===!0&&(r+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",r,"ms for the response, maxNetworkDelay",n);var i=this;t.timeout=this.setTimeout(function(){t.expired=!0,t.xhr&&t.xhr.abort();var n="Request "+t.id+" of transport "+i.getType()+" exceeded "+r+" ms max network delay";i._debug(n),i.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,"timeout",n)},r)}}function a(e){var t=++n,r={id:t,metaConnect:!1};i.length<this.getConfiguration().maxConnections-1?(i.push(r),u.call(this,e,r)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),s.push([e,r]))}function f(e){var t=e.id;this._debug("Transport",this.getType(),"metaConnect complete, request",t);if(r!==null&&r.id!==t)throw"Longpoll request mismatch, completing request "+t;r=null}function l(e,t){var n=org.cometd.Utils.inArray(e,i);n>=0&&i.splice(n,1);if(s.length>0){var r=s.shift(),u=r[0],f=r[1];this._debug("Transport dequeued request",f.id);if(t)this.getConfiguration().autoBatch&&o.call(this,u),a.call(this,u),this._debug("Transport completed request",e.id,u);else{var l=this;this.setTimeout(function(){l.complete(f,!1,f.metaConnect),u.onFailure(f.xhr,u.messages,"error","Previous request failed")},0)}}}function c(e){if(r!==null)throw"Concurrent metaConnect requests not allowed, request id="+r.id+" not yet completed";var t=++n;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e);var i={id:t,metaConnect:!0};u.call(this,e,i),r=i}var e=new org.cometd.Transport,t=org.cometd.Transport.derive(e),n=0,r=null,i=[],s=[];return t.complete=function(e,t,n){n?f.call(this,e):l.call(this,e,t)},t.transportSend=function(e,t){throw"Abstract"},t.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&n.length>0?e.onSuccess(n):e.onFailure(t.xhr,e.messages,"Empty HTTP response"))},t.transportFailure=function(e,t,n,r){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n,r))},t.send=function(e,t){t?c.call(this,e):a.call(this,e)},t.abort=function(){e.abort();for(var t=0;t<i.length;++t){var n=i[t];this._debug("Aborting request",n),n.xhr&&n.xhr.abort()}r&&(this._debug("Aborting metaConnect request",r),r.xhr&&r.xhr.abort()),this.reset()},t.reset=function(){e.reset(),r=null,i=[],s=[]},t},org.cometd.LongPollingTransport=function(){var e=new org.cometd.RequestTransport,t=org.cometd.Transport.derive(e),n=!0;return t.accept=function(e,t,r){return n||!t},t.xhrSend=function(e){throw"Abstract"},t.transportSend=function(e,t){this._debug("Transport",this.getType(),"sending request",t.id,"envelope",e);var r=this;try{var i=!0;t.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(e.messages),onSuccess:function(i){r._debug("Transport",r.getType(),"received response",i);var s=!1;try{var o=r.convertToMessages(i);o.length===0?(n=!1,r.transportFailure(e,t,"no response",null)):(s=!0,r.transportSuccess(e,t,o))}catch(u){r._debug(u),s||(n=!1,r.transportFailure(e,t,"bad response",u))}},onError:function(s,o){n=!1,i?r.setTimeout(function(){r.transportFailure(e,t,s,o)},0):r.transportFailure(e,t,s,o)}}),i=!1}catch(s){n=!1,this.setTimeout(function(){r.transportFailure(e,t,"error",s)},0)}},t.reset=function(){e.reset(),n=!0},t},org.cometd.CallbackPollingTransport=function(){var e=new org.cometd.RequestTransport,t=org.cometd.Transport.derive(e),n=2e3;return t.accept=function(e,t,n){return!0},t.jsonpSend=function(e){throw"Abstract"},t.transportSend=function(e,t){var r=this,i=0,s=e.messages.length,o=[];while(s>0){var u=org.cometd.JSON.toJSON(e.messages.slice(i,i+s)),a=e.url.length+encodeURI(u).length;if(a>n){if(s===1){var f="Bayeux message too big ("+a+" bytes, max is "+n+") "+"for transport "+this.getType();this.setTimeout(function(){r.transportFailure(e,t,"error",f)},0);return}--s;continue}o.push(s),i+=s,s=e.messages.length-i}var l=e;if(o.length>1){var c=0,h=o[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",o.join(" + ")),l=this._mixin(!1,{},e),l.messages=e.messages.slice(c,h),l.onSuccess=e.onSuccess,l.onFailure=e.onFailure;for(var p=1;p<o.length;++p){var d=this._mixin(!1,{},e);c=h,h+=o[p],d.messages=e.messages.slice(c,h),d.onSuccess=e.onSuccess,d.onFailure=e.onFailure,this.send(d,t.metaConnect)}}this._debug("Transport",this.getType(),"sending request",t.id,"envelope",l);try{var v=!0;this.jsonpSend({transport:this,url:l.url,sync:l.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(l.messages),onSuccess:function(e){var n=!1;try{var i=r.convertToMessages(e);i.length===0?r.transportFailure(l,t,"no response"):(n=!0,r.transportSuccess(l,t,i))}catch(s){r._debug(s),n||r.transportFailure(l,t,"bad response",s)}},onError:function(e,n){v?r.setTimeout(function(){r.transportFailure(l,t,e,n)},0):r.transportFailure(l,t,e,n)}}),v=!1}catch(m){this.setTimeout(function(){r.transportFailure(l,t,"error",m)},0)}},t},org.cometd.WebSocketTransport=function(){function c(){var e=n.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",e);var t=this,r=null,i=n.getConfiguration().connectTimeout;i>0&&(r=this.setTimeout(function(){r=null,a||(t._debug("Transport",t.getType(),"timed out while connecting to URL",e,":",i,"ms"),t.onClose(1002,"Connect Timeout"))},i));var s=new org.cometd.WebSocket(e);s.onopen=function(){t._debug("WebSocket opened",s),r&&(t.clearTimeout(r),r=null);if(s!==u){t._debug("Ignoring open event, WebSocket",u);return}t.onOpen()},s.onclose=function(e){var n=e?e.code:1e3,i=e?e.reason:undefined;t._debug("WebSocket closed",n,"/",i,s),r&&(t.clearTimeout(r),r=null);if(s!==u){t._debug("Ignoring close event, WebSocket",u);return}t.onClose(n,i)},s.onerror=function(){s.onclose({code:1002})},s.onmessage=function(e){t._debug("WebSocket message",e,s);if(s!==u){t._debug("Ignoring message event, WebSocket",u);return}t.onMessage(e)},u=s,this._debug("Transport",this.getType(),"configured callbacks on",s)}function h(e,t){var n=org.cometd.JSON.toJSON(e.messages);u.send(n),this._debug("Transport",this.getType(),"sent",e,"metaConnect =",t);var r=this.getConfiguration().maxNetworkDelay,i=r;t&&(i+=this.getAdvice().timeout,f=!0);var s=[];for(var a=0;a<e.messages.length;++a){var l=e.messages[a];if(l.id){s.push(l.id);var c=this;o[l.id]=this.setTimeout(function(){u&&u.close(1e3,"Timeout")},i)}}this._debug("Transport",this.getType(),"waiting at most",i,"ms for messages",s,"maxNetworkDelay",r,", timeouts:",o)}function p(e,t){try{u===null?c.call(this):a&&h.call(this,e,t)}catch(n){this.setTimeout(function(){e.onFailure(u,e.messages,"error",n)},0)}}var e=new org.cometd.Transport,t=org.cometd.Transport.derive(e),n,r=!0,i=!1,s={},o={},u=null,a=!1,f=!1,l;return t.onOpen=function(){this._debug("Transport",this.getType(),"opened",u),a=!0,i=!0,this._debug("Sending pending messages",s);for(var e in s){var t=s[e],n=t[0],r=t[1];l=n.onSuccess,h.call(this,n,r)}},t.onMessage=function(e){this._debug("Transport",this.getType(),"received websocket message",e,u);var t=!1,n=this.convertToMessages(e.data),r=[];for(var i=0;i<n.length;++i){var a=n[i];if(/^\/meta\//.test(a.channel)||a.data===undefined)if(a.id){r.push(a.id);var c=o[a.id];c&&(this.clearTimeout(c),delete o[a.id],this._debug("Transport",this.getType(),"removed timeout for message",a.id,", timeouts",o))}"/meta/connect"===a.channel&&(f=!1),"/meta/disconnect"===a.channel&&!f&&(t=!0)}var h=!1;for(var p=0;p<r.length;++p){var d=r[p];for(var v in s){var m=v.split(","),g=org.cometd.Utils.inArray(d,m);if(g>=0){h=!0,m.splice(g,1);var y=s[v][0],b=s[v][1];delete s[v],m.length>0&&(s[m.join(",")]=[y,b]);break}}}h&&this._debug("Transport",this.getType(),"removed envelope, envelopes",s),l.call(this,n),t&&u.close(1e3,"Disconnect")},t.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t,u),r=i;for(var n in o)this.clearTimeout(o[n]);o={};for(var l in s){var c=s[l][0],h=s[l][1];h&&(f=!1),c.onFailure(u,c.messages,"closed "+e+"/"+t)}s={},u!==null&&a&&u.close(1e3,"Close"),a=!1,u=null},t.registered=function(t,r){e.registered(t,r),n=r},t.accept=function(e,t,i){return r&&!!org.cometd.WebSocket&&n.websocketEnabled!==!1},t.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t);var n=[];for(var r=0;r<e.messages.length;++r){var i=e.messages[r];i.id&&n.push(i.id)}s[n.join(",")]=[e,t],this._debug("Transport",this.getType(),"stored envelope, envelopes",s),p.call(this,e,t)},t.reset=function(){e.reset(),u!==null&&a&&u.close(1e3,"Reset"),r=!0,i=!1,o={},s={},u=null,a=!1,l=null},t},org.cometd.Cometd=function(e){function E(e){return org.cometd.Utils.isString(e)}function S(e){return e===undefined||e===null?!1:typeof e=="function"}function x(e,t){if(window.console){var n=window.console[e];S(n)&&n.apply(window.console,t)}}function T(e){t._debug("Configuring cometd object with",e),E(e)&&(e={url:e}),e||(e={}),w=t._mixin(!1,w,e);if(!w.url)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var n=/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(w.url),i=n[2],s=n[8],o=n[9];r=t._isCrossDomain(i);if(w.appendMessageTypeToURL)if(o!==undefined&&o.length>0)t._info("Appending message type to URI "+s+o+" is not supported, disabling 'appendMessageTypeToURL' configuration"),w.appendMessageTypeToURL=!1;else{var u=s.split("/"),a=u.length-1;s.match(/\/$/)&&(a-=1),u[a].indexOf(".")>=0&&(t._info("Appending message type to URI "+s+" is not supported, disabling 'appendMessageTypeToURL' configuration"),w.appendMessageTypeToURL=!1)}}function N(){for(var e in h){var n=h[e];for(var r=0;r<n.length;++r){var i=n[r];i&&!i.listener&&(delete n[r],t._debug("Removed subscription",i,"for channel",e))}}}function C(e){o!==e&&(t._debug("Status",o,"->",e),o=e)}function k(){return o==="disconnecting"||o==="disconnected"}function L(){return++u}function A(e,n,r,i,s){try{return n.call(e,i)}catch(o){t._debug("Exception during execution of extension",r,o);var u=t.onExtensionException;if(S(u)){t._debug("Invoking extension exception callback",r,o);try{u.call(t,o,r,s,i)}catch(a){t._info("Exception during execution of exception callback in extension",r,a)}}return i}}function O(e){for(var t=0;t<v.length;++t){if(e===undefined||e===null)break;var n=w.reverseIncomingExtensions?v.length-1-t:t,r=v[n],i=r.extension.incoming;if(S(i)){var s=A(r.extension,i,r.name,e,!1);e=s===undefined?e:s}}return e}function M(e){for(var t=0;t<v.length;++t){if(e===undefined||e===null)break;var n=v[t],r=n.extension.outgoing;if(S(r)){var i=A(n.extension,r,n.name,e,!0);e=i===undefined?e:i}}return e}function _(e,n){var r=h[e];if(r&&r.length>0)for(var i=0;i<r.length;++i){var s=r[i];if(s)try{s.callback.call(s.scope,n)}catch(o){t._debug("Exception during notification",s,n,o);var u=t.onListenerException;if(S(u)){t._debug("Invoking listener exception callback",s,o);try{u.call(t,o,s.handle,s.listener,n)}catch(a){t._info("Exception during execution of listener callback",s,a)}}}}}function D(e,t){_(e,t);var n=e.split("/"),r=n.length-1;for(var i=r;i>0;--i){var s=n.slice(0,i).join("/")+"/*";i===r&&_(s,t),s+="*",_(s,t)}}function P(){d!==null&&org.cometd.Utils.clearTimeout(d),d=null}function H(e){P();var n=m.interval+p;t._debug("Function scheduled in",n,"ms, interval =",m.interval,"backoff =",p,e),d=org.cometd.Utils.setTimeout(t,e,n)}function F(e,n,r,i){for(var o=0;o<n.length;++o){var u=n[o];u.id=""+L(),a&&(u.clientId=a),u=M(u),u!==undefined&&u!==null?n[o]=u:n.splice(o--,1)}if(n.length===0)return;var f=w.url;w.appendMessageTypeToURL&&(f.match(/\/$/)||(f+="/"),i&&(f+=i));var l={url:f,sync:e,messages:n,onSuccess:function(e){try{B.call(t,e)}catch(n){t._debug("Exception during handling of messages",n)}},onFailure:function(e,n,r,i){try{j.call(t,e,n,r,i)}catch(s){t._debug("Exception during handling of failure",s)}}};t._debug("Send",l),s.send(l,r)}function I(e){f>0||c===!0?l.push(e):F(!1,[e],!1)}function q(){p=0}function R(){p<w.maxBackoff&&(p+=w.backoffIncrement)}function U(){++f}function z(){var e=l;l=[],e.length>0&&F(!1,e,!1)}function W(){--f;if(f<0)throw"Calls to startBatch() and endBatch() are not paired";f===0&&!k()&&!c&&z()}function X(){if(!k()){var e={channel:"/meta/connect",connectionType:s.getType()};b||(e.advice={timeout:0}),C("connecting"),t._debug("Connect sent",e),F(!1,[e],!0,"connect"),C("connected")}}function V(){C("connecting"),H(function(){X()})}function $(e){e&&(m=t._mixin(!1,{},w.advice,e),t._debug("New advice",m))}function J(e){P(),e&&s.abort(),a=null,C("disconnected"),f=0,q(),l.length>0&&(j.call(t,undefined,l,"error","Disconnected"),l=[])}function K(e){a=null,N(),k()?(i.reset(),$(w.advice)):$(t._mixin(!1,m,{reconnect:"retry"})),f=0,c=!0,g=e;var n="1.0",o=i.findTransportTypes(n,r,w.url),u={version:n,minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:o,advice:{timeout:m.timeout,interval:m.interval}},l=t._mixin(!1,{},g,u);s=i.negotiateTransport(o,n,r,w.url),t._debug("Initial transport is",s.getType()),C("handshaking"),t._debug("Handshake sent",l),F(!1,[l],!1,"handshake")}function Q(){C("handshaking"),c=!0,H(function(){K(g)})}function G(e){D("/meta/handshake",e),D("/meta/unsuccessful",e);var t=!k()&&m.reconnect!=="none";t?(R(),Q()):J(!1)}function Y(e){if(e.successful){a=e.clientId;var n=i.negotiateTransport(e.supportedConnectionTypes,e.version,r,w.url);if(n===null)throw"Could not negotiate transport with server; client "+i.findTransportTypes(e.version,r,w.url)+", server "+e.supportedConnectionTypes;s!==n&&(t._debug("Transport",s,"->",n),s=n),c=!1,z(),e.reestablish=y,y=!0,D("/meta/handshake",e);var o=k()?"none":m.reconnect;switch(o){case"retry":q(),V();break;case"none":J(!1);break;default:throw"Unrecognized advice action "+o}}else G(e)}function Z(e,t){G({successful:!1,failure:!0,channel:"/meta/handshake",request:t,xhr:e,advice:{reconnect:"retry",interval:p}})}function et(e){D("/meta/connect",e),D("/meta/unsuccessful",e);var t=k()?"none":m.reconnect;switch(t){case"retry":V(),R();break;case"handshake":i.reset(),q(),Q();break;case"none":J(!1);break;default:throw"Unrecognized advice action"+t}}function tt(e){b=e.successful;if(b){D("/meta/connect",e);var t=k()?"none":m.reconnect;switch(t){case"retry":q(),V();break;case"none":J(!1);break;default:throw"Unrecognized advice action "+t}}else et(e)}function nt(e,t){b=!1,et({successful:!1,failure:!0,channel:"/meta/connect",request:t,xhr:e,advice:{reconnect:"retry",interval:p}})}function rt(e){J(!0),D("/meta/disconnect",e),D("/meta/unsuccessful",e)}function it(e){e.successful?(J(!1),D("/meta/disconnect",e)):rt(e)}function st(e,t){rt({successful:!1,failure:!0,channel:"/meta/disconnect",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function ot(e){D("/meta/subscribe",e),D("/meta/unsuccessful",e)}function ut(e){e.successful?D("/meta/subscribe",e):ot(e)}function at(e,t){ot({successful:!1,failure:!0,channel:"/meta/subscribe",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function ft(e){D("/meta/unsubscribe",e),D("/meta/unsuccessful",e)}function lt(e){e.successful?D("/meta/unsubscribe",e):ft(e)}function ct(e,t){ft({successful:!1,failure:!0,channel:"/meta/unsubscribe",request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function ht(e){D("/meta/publish",e),D("/meta/unsuccessful",e)}function pt(e){e.successful===undefined?e.data?D(e.channel,e):t._debug("Unknown message",e):e.successful?D("/meta/publish",e):ht(e)}function dt(e,t){ht({successful:!1,failure:!0,channel:t.channel,request:t,xhr:e,advice:{reconnect:"none",interval:0}})}function vt(e){e=O(e);if(e===undefined||e===null)return;$(e.advice);var t=e.channel;switch(t){case"/meta/handshake":Y(e);break;case"/meta/connect":tt(e);break;case"/meta/disconnect":it(e);break;case"/meta/subscribe":ut(e);break;case"/meta/unsubscribe":lt(e);break;default:pt(e)}}function mt(e){var t=h[e];if(t)for(var n=0;n<t.length;++n)if(t[n])return!0;return!1}function gt(e,t){var n={scope:e,method:t};if(S(e))n.scope=undefined,n.method=e;else if(E(t)){if(!e)throw"Invalid scope "+e;n.method=e[t];if(!S(n.method))throw"Invalid callback "+t+" for scope "+e}else if(!S(t))throw"Invalid callback "+t;return n}function yt(e,n,r,i){var s=gt(n,r);t._debug("Adding listener on",e,"with scope",s.scope,"and callback",s.method);var o={channel:e,scope:s.scope,callback:s.method,listener:i},u=h[e];u||(u=[],h[e]=u);var a=u.push(o)-1;return o.id=a,o.handle=[e,a],t._debug("Added listener",o,"for channel",e,"having id =",a),o.handle}function bt(e){var n=h[e[0]];n&&(delete n[e[1]],t._debug("Removed listener",e))}var t=this,n=e||"default",r=!1,i=new org.cometd.TransportRegistry,s,o="disconnected",u=0,a=null,f=0,l=[],c=!1,h={},p=0,d=null,v=[],m={},g,y=!1,b=!1,w={connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,advice:{timeout:6e4,interval:0,reconnect:"retry"}};this._mixin=function(e,t,n){var r=t||{};for(var i=2;i<arguments.length;++i){var s=arguments[i];if(s===undefined||s===null)continue;for(var o in s){var u=s[o],a=r[o];if(u===t)continue;if(u===undefined)continue;if(e&&typeof u=="object"&&u!==null)if(u instanceof Array)r[o]=this._mixin(e,a instanceof Array?a:[],u);else{var f=typeof a!="object"||a instanceof Array?{}:a;r[o]=this._mixin(e,f,u)}else r[o]=u}}return r},this._warn=function(){x("warn",arguments)},this._info=function(){w.logLevel!=="warn"&&x("info",arguments)},this._debug=function(){w.logLevel==="debug"&&x("debug",arguments)},this._isCrossDomain=function(e){return e&&e!==window.location.host};var B,j;this.send=I,this.receive=vt,B=function(e){t._debug("Received",e);for(var n=0;n<e.length;++n){var r=e[n];vt(r)}},j=function(e,n,r,i){t._debug("handleFailure",e,n,r,i);for(var s=0;s<n.length;++s){var o=n[s],u=o.channel;switch(u){case"/meta/handshake":Z(e,o);break;case"/meta/connect":nt(e,o);break;case"/meta/disconnect":st(e,o);break;case"/meta/subscribe":at(e,o);break;case"/meta/unsubscribe":ct(e,o);break;default:dt(e,o)}}},this.registerTransport=function(e,t,n){var r=i.add(e,t,n);return r&&(this._debug("Registered transport",e),S(t.registered)&&t.registered(e,this)),r},this.getTransportTypes=function(){return i.getTransportTypes()},this.unregisterTransport=function(e){var t=i.remove(e);return t!==null&&(this._debug("Unregistered transport",e),S(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){i.clear()},this.findTransport=function(e){return i.find(e)},this.configure=function(e){T.call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e){C("disconnected"),y=!1,K(e)},this.disconnect=function(e,t){if(k())return;t===undefined&&typeof e!="boolean"&&(t=e,e=!1);var n={channel:"/meta/disconnect"},r=this._mixin(!1,{},t,n);C("disconnecting"),F(e===!0,[r],!1,"disconnect")},this.startBatch=function(){U()},this.endBatch=function(){W()},this.batch=function(e,t){var n=gt(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(r){throw this._debug("Exception during execution of batch",r),this.endBatch(),r}},this.addListener=function(e,t,n){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!E(e))throw"Illegal argument type: channel must be a string";return yt(e,t,n,!0)},this.removeListener=function(e){if(!org.cometd.Utils.isArray(e))throw"Invalid argument: expected subscription, not "+e;bt(e)},this.clearListeners=function(){h={}},this.subscribe=function(e,t,n,r){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!E(e))throw"Illegal argument type: channel must be a string";if(k())throw"Illegal state: already disconnected";S(t)&&(r=n,n=t,t=undefined);var i=!mt(e),s=yt(e,t,n,!1);if(i){var o={channel:"/meta/subscribe",subscription:e},u=this._mixin(!1,{},r,o);I(u)}return s},this.unsubscribe=function(e,t){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(k())throw"Illegal state: already disconnected";this.removeListener(e);var n=e[0];if(!mt(n)){var r={channel:"/meta/unsubscribe",subscription:n},i=this._mixin(!1,{},t,r);I(i)}},this.clearSubscriptions=function(){N()},this.publish=function(e,t,n){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!E(e))throw"Illegal argument type: channel must be a string";if(k())throw"Illegal state: already disconnected";var r={channel:e,data:t},i=this._mixin(!1,{},n,r);I(i)},this.getStatus=function(){return o},this.isDisconnected=k,this.setBackoffIncrement=function(e){w.backoffIncrement=e},this.getBackoffIncrement=function(){return w.backoffIncrement},this.getBackoffPeriod=function(){return p},this.setLogLevel=function(e){w.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!E(e))throw"Illegal argument type: extension name must be a string";var n=!1;for(var r=0;r<v.length;++r){var i=v[r];if(i.name===e){n=!0;break}}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(v.push({name:e,extension:t}),this._debug("Registered extension",e),S(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!E(e))throw"Illegal argument type: extension name must be a string";var t=!1;for(var n=0;n<v.length;++n){var r=v[n];if(r.name===e){v.splice(n,1),t=!0,this._debug("Unregistered extension",e);var i=r.extension;S(i.unregistered)&&i.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<v.length;++t){var n=v[t];if(n.name===e)return n.extension}return null},this.getName=function(){return n},this.getClientId=function(){return a},this.getURL=function(){return w.url},this.getTransport=function(){return s},this.getConfiguration=function(){return this._mixin(!0,{},w)},this.getAdvice=function(){return this._mixin(!0,{},m)},org.cometd.WebSocket=window.WebSocket,org.cometd.WebSocket||(org.cometd.WebSocket=window.MozWebSocket)},typeof dojo!="undefined"&&dojo.provide("org.cometd.AckExtension"),org.cometd.AckExtension=function(){function r(t,n){e._debug(t,n)}var e,t=!1,n=-1;this.registered=function(t,n){e=n,r("AckExtension: executing registration callback")},this.unregistered=function(){r("AckExtension: executing unregistration callback"),e=null},this.incoming=function(e){var i=e.channel;if(i=="/meta/handshake")t=e.ext&&e.ext.ack,r("AckExtension: server supports acks",t);else if(t&&i=="/meta/connect"&&e.successful){var s=e.ext;s&&typeof s.ack=="number"&&(n=s.ack,r("AckExtension: server sent ack id",n))}return e},this.outgoing=function(i){var s=i.channel;return s=="/meta/handshake"?(i.ext||(i.ext={}),i.ext.ack=e&&e.ackEnabled!==!1,n=-1):t&&s=="/meta/connect"&&(i.ext||(i.ext={}),i.ext.ack=n,r("AckExtension: client sending ack id",n)),i}},typeof dojo!="undefined"&&dojo.provide("org.cometd.ReloadExtension"),org.cometd.COOKIE||(org.cometd.COOKIE={},org.cometd.COOKIE.set=function(e,t,n){throw"Abstract"},org.cometd.COOKIE.get=function(e){throw"Abstract"}),org.cometd.ReloadExtension=function(e){function a(e){if(r&&r.handshakeResponse!==null){l(e),r.cookiePath=s;var t=org.cometd.JSON.toJSON(r);n("Reload extension saving cookie value",t),org.cometd.COOKIE.set(i,t,{"max-age":o,path:s,expires:new Date((new Date).getTime()+o*1e3)})}}function f(e){return r.url==e.url}function l(e){e&&(typeof e.cookieMaxAge=="number"&&(o=e.cookieMaxAge),typeof e.cookieName=="string"&&(i=e.cookieName),typeof e.cookiePath=="string"&&(s=e.cookiePath))}var t,n,r=null,i="org.cometd.reload",s="/",o=5,u=!1;this.configure=l,this.registered=function(e,r){t=r,t.reload=a,n=t._debug},this.unregistered=function(){delete t.reload,t=null},this.outgoing=function(e){var s=e.channel;if(s=="/meta/handshake"){r={},r.url=t.getURL();var o=org.cometd.COOKIE.get(i);n("Reload extension found cookie value",o);if(o)try{var a=org.cometd.JSON.fromJSON(o);org.cometd.COOKIE.set(i,"",{"max-age":-1,path:a.cookiePath,expires:-1});if(a.handshakeResponse&&f(a))return n("Reload extension restoring state",a),setTimeout(function(){n("Reload extension replaying handshake response",a.handshakeResponse),r.handshakeResponse=a.handshakeResponse,r.transportType=a.transportType,r.reloading=!0;var e=t._mixin(!0,{},r.handshakeResponse,{ext:{reload:!0}});e.supportedConnectionTypes=[r.transportType],t.receive(e),n("Reload extension replayed handshake response",e)},0),u||(u=!0,t.startBatch()),null;n("Reload extension could not restore state",a)}catch(l){n("Reload extension error while trying to restore cookie",l)}}else s=="/meta/connect"&&(r.transportType||(r.transportType=e.connectionType,n("Reload extension tracked transport type",r.transportType)));return e},this.incoming=function(e){if(e.successful)switch(e.channel){case"/meta/handshake":r.handshakeResponse||(r.handshakeResponse=e,n("Reload extension tracked handshake response",e));break;case"/meta/disconnect":r=null;break;case"/meta/connect":u&&(t.endBatch(),u=!1);break;default:}return e},l(e)};var JSON;JSON||(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(e){function t(e,t){if(t)for(var n in t){if(n.toLowerCase()==="content-type")continue;e.setRequestHeader(n,t[n])}}function n(){var n=new org.cometd.LongPollingTransport,r=org.cometd.Transport.derive(n);return r.xhrSend=function(n){return e.ajax({url:n.url,async:n.sync!==!0,type:"POST",contentType:"application/json;charset=UTF-8",data:n.body,xhrFields:{withCredentials:!0},beforeSend:function(e){return t(e,n.headers),!0},success:n.onSuccess,error:function(e,t,r){n.onError(t,r)}})},r}function r(){var n=new org.cometd.CallbackPollingTransport,r=org.cometd.Transport.derive(n);return r.jsonpSend=function(n){e.ajax({url:n.url,async:n.sync!==!0,type:"GET",dataType:"jsonp",jsonp:"jsonp",data:{message:n.body},beforeSend:function(e){return t(e,n.headers),!0},success:n.onSuccess,error:function(e,t,r){n.onError(t,r)}})},r}org.cometd.JSON.toJSON=JSON.stringify,org.cometd.JSON.fromJSON=JSON.parse,e.Cometd=function(e){var t=new org
.cometd.Cometd(e);return org.cometd.WebSocket&&t.registerTransport("websocket",new org.cometd.WebSocketTransport),t.registerTransport("long-polling",new n),t.registerTransport("callback-polling",new r),t},e.cometd=new e.Cometd}(jQuery),function(e){e.cometd.registerExtension("ack",new org.cometd.AckExtension)}(jQuery);var CryptoJS=CryptoJS||function(e,t){var n={},r=n.lib={},i=r.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var n=new e;return t&&n.mixIn(t),n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.$super.extend(this)}}}(),s=r.WordArray=i.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,e=e.sigBytes;this.clamp();if(r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return s.create(n,t)}}),o=n.enc={},u=o.Hex={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-8*(r%4)&255;n.push((i>>>4).toString(16)),n.push((i&15).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-4*(r%8);return s.create(n,t/2)}},a=o.Latin1={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-8*(r%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(e.charCodeAt(r)&255)<<24-8*(r%4);return s.create(n,t)}},f=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(a.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return a.parse(unescape(encodeURIComponent(e)))}},l=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=s.create(),this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=f.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,u=i/(4*o),u=t?e.ceil(u):e.max((u|0)-this._minBufferSize,0),t=u*o,i=e.min(4*t,i);if(t){for(var a=0;a<t;a+=o)this._doProcessBlock(r,a);a=r.splice(0,t),n.sigBytes-=i}return s.create(a,i)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=l.extend({init:function(){this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize(),this._hash},clone:function(){var e=l.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:16,_createHelper:function(e){return function(t,n){return e.create(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return c.HMAC.create(e,n).finalize(t)}}});var c=n.algo={};return n}(Math);(function(){var e=CryptoJS,t=e.lib,n=t.WordArray,t=t.Hasher,r=[],i=e.algo.SHA1=t.extend({_doReset:function(){this._hash=n.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=0;80>f;f++){if(16>f)r[f]=e[t+f]|0;else{var l=r[f-3]^r[f-8]^r[f-14]^r[f-16];r[f]=l<<1|l>>>31}l=(i<<5|i>>>27)+a+r[f],l=20>f?l+((s&o|~s&u)+1518500249):40>f?l+((s^o^u)+1859775393):60>f?l+((s&o|s&u|o&u)-1894007588):l+((s^o^u)-899497514),a=u,u=o,o=s<<30|s>>>2,s=i,i=l}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+o|0,n[3]=n[3]+u|0,n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[(r+64>>>9<<4)+15]=n,e.sigBytes=4*t.length,this._process()}});e.SHA1=t._createHelper(i),e.HmacSHA1=t._createHmacHelper(i)})(),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=e.create(),"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n));for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),u=s.words,a=o.words,f=0;f<r;f++)u[f]^=1549556828,a[f]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();for(var e=[],i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-8*(i%4)&255)<<16|(t[i+1>>>2]>>>24-8*((i+1)%4)&255)<<8|t[i+2>>>2]>>>24-8*((i+2)%4)&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var e=e.replace(/\s/g,""),n=e.length,r=this._map,s=r.charAt(64);s&&(s=e.indexOf(s),-1!=s&&(n=s));for(var s=[],o=0,u=0;u<n;u++)if(u%4){var a=r.indexOf(e.charAt(u-1))<<2*(u%4),f=r.indexOf(e.charAt(u))>>>6-2*(u%4);s[o>>>2]|=(a|f)<<24-8*(o%4),o++}return t.create(s,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();var importio=function(e){function c(e){n?e&&e():(e&&f.push(e),r||w())}function p(){var e="",t="abcdefghijklmnopqrstuvwxyz0123456789";for(var n=0;n<30;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function d(){if(l)return l;c();var e=u.hostPrefix;e=e.length>20?e.substring(0,20):e,e=e.length>0?e+"-":"";var t=window.location.hostname?window.location.hostname.replace(/\./g,""):"";t=t.length>20?t.substring(0,20):t,t=t.length>0?t+"-":"";var n=e+t+p(),r=u.randomHost?n+".query."+u.host:"query."+u.host,i=u.port;u.port||(u.https?i=443:i=80);var s="http"+(u.https?"s":"");return l=s+"://"+r+":"+i+"/query/comet",v(l)}function v(e){return c(),u.logging&&window.console&&console.log&&console.log(e),e}function m(){if(i.started)return;e.cometd.websocketEnabled=!1,e.cometd.configure({url:d(),logLevel:u.logging?"debug":"warn",autoBatch:!0}),e.cometd.handshake(),e.cometd.addListener("/meta/handshake",i.callbacks.handshake),e.cometd.addListener("/meta/connect",i.callbacks.connect),e.cometd.onListenerException=function(e,t,n,r){u.logging&&window.console&&console.error&&console.error("Unable to call listener, exception thrown",{exception:e,subscriptionHandle:t,isListener:n,message:r})},i.started=!0}function g(e){i.wasConnected=i.connected,i.connected=e.successful===!0,!i.wasConnected&&i.connected?(i.callbacks.connected(),b()):i.wasConnected&&!i.connected?i.callbacks.broken():i.connected||i.callbacks.closed(e.advice["multiple-clients"])}function y(e,t){if(typeof t=="undefined"||!t)return e;if(t instanceof Function)e.done(t);else if(t instanceof Array)e.done(t);else{var n=e.promise();for(var r in t)n.hasOwnProperty(r)&&n[r]instanceof Function&&n[r](t[r])}return e}function b(){n=!0,r=!1;for(var e in f)f[e]()}function w(e){r=!0;if(typeof e=="undefined")e=o;else for(var t in o)o.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&(e[t]=o[t]);return Object.prototype.toString.call(e.connectionCallbacks)!=="[object Array]"&&(e[connectionCallbacks]=[e.connectionCallbacks]),u=e,m(),v(u)}function E(e){e&&typeof e=="function"&&u.connectionCallbacks.push(e)}function S(n,r){var i=e.Deferred(!1);return i=y(i,r),c(function(){var o=new t(e,u,n,i,r,function(e){delete s[e]});s[o.getId()]=o,o.start()}),i.promise()}function x(){return o}function T(){var e={};for(var t in u)e[t]=u[t];return e}function N(e,t){u[e]=t}function C(e,t){var n=u.port;return u.port||(u.https?n=443:n=80),"withCredentials"in new XMLHttpRequest&&!t?"http"+(u.https?"s":"")+"://api."+u.host+":"+n+(e?e:""):"/~api"+(e?e:"")}function k(t,n,r,i){var s={type:t,dataType:"json"},r=r||{},o={},a=!1,f=u.auth;return f instanceof Object&&f.hasOwnProperty("userGuid")&&f.hasOwnProperty("apiKey")&&(o={_user:f.userGuid,_apikey:f.apiKey},a=!0),t=="GET"||t=="HEAD"?(a&&(r._user=o._user,r._apikey=o._apikey),n+=L(r,"?")):(i?s.data=r:(s.contentType=r?"application/json":undefined,s.data=r?JSON.stringify(r):undefined),a&&(n+=L(o,"?"))),e.ajax(C(n),s)}function L(e,t){var n="";if(e){var r=[];for(var i in e)e.hasOwnProperty(i)&&e[i]&&(e[i]instanceof Array||(e[i]=[e[i]]),e[i].map(function(e){r.push(i+"="+encodeURIComponent(e))}));r.length&&(n+=(t?t:"")+r.join("&"))}return n}function A(t){var n=t,r={search:function(t,i,s){var o="/store/"+n+(s||"/_search");i||(i={}),i.q=t;if(n.toLowerCase()!="connector")return k("GET",o,i);var u=e.Deferred();return k("GET",o,i).then(function(e){var t={};e.hits.hits.map(function(e){e.fields.hasOwnProperty("parentGuid")&&e.fields.parentGuid&&(t[e.fields.parentGuid]=e._id)}),Object.keys(t).length?r.get({id:Object.keys(t)}).then(function(t){t.map(function(t){e.hits.hits.map(function(e){if(e.fields.hasOwnProperty("parentGuid")&&e.fields.parentGuid==t.guid)for(var n in t)!e.fields.hasOwnProperty(n)&&n!="guid"&&(e.fields[n]=t[n])})}),u.resolve(e)},u.reject):u.resolve(e)},u.reject),u.promise()},list:function(e,t,r){var i={index:e,index_value:t};r&&(i.index_offset=[t,r]);var s="/store/"+n;return k("GET",s,i)},get:function(t){if(n.toLowerCase()!="connector")return k("GET","/store/"+n,t);var i=e.Deferred();return k("GET","/store/"+n,t).then(function(e){var t={};e.map(function(e){e.hasOwnProperty("parentGuid")&&e.parentGuid&&(t[e.parentGuid]=e._id)}),Object.keys(t).length?r.get({id:Object.keys(t)}).then(function(t){t.map(function(t){e.map(function(e){if(e.hasOwnProperty("parentGuid")&&e.parentGuid==t.guid)for(var n in t)!e.hasOwnProperty(n)&&n!="guid"&&(e[n]=t[n])})}),i.resolve(e)},i.reject):i.resolve(e)},i.reject),i.promise()},object:function(t){function i(e,t,i){var s=i||r,o="/store/"+n+(s?"/"+s:"");return k(e,o,t)}var r=t,s={get:function(){if(n.toLowerCase()!="connector")return i("GET");var t=e.Deferred();return i("GET").then(function(e){e.hasOwnProperty("parentGuid")&&e.parentGuid?i("GET",!1,e.parentGuid).then(function(n){for(var r in e)n[r]=e[r];t.resolve(n)},t.reject):t.resolve(e)},t.reject),t.promise()},post:function(e){return i("POST",e)},put:function(e){return i("PUT",e)},patch:function(e){return i("PATCH",e)},del:function(){return i("DELETE")},plugin:function(e,t,i){i||(i={});var s;i.hasOwnProperty("object")&&i.object&&(s=i.object,delete i.object);var o="/store/"+n+(r?"/"+r:"")+"/_"+e+(s?"/"+s:"");return k(t,o,i)},children:function(e){var t=e,i={get:function(e){var i="/store/"+n+(r?"/"+r:"")+"/"+t;return k("GET",i,e)}};return i.read=i.get,i}};return s.read=s.get,s.create=s.post,s.update=s.put,s.tweak=s.patch,s.remove=s.del,s}};return r.create=r.object().create,r.children=r.object().children,r.plugin=r.object().plugin,r}e(document).ajaxSend(function(e,t,n){n.xhrFields={withCredentials:!0}});var t=function(e,t,n,r,i,s){function p(){return o}function d(){if(t.hasOwnProperty("auth")){var r=t.auth;if(r instanceof Object&&t.auth.hasOwnProperty("userGuid")&&t.auth.hasOwnProperty("apiKey")){var i=300;t.auth.hasOwnProperty("validPeriod")&&(i=t.auth.hasOwnProperty("validPeriod"));var s="00000000-0000-0000-0000-000000000000";t.auth.hasOwnProperty("orgGuid")&&(s=t.auth.hasOwnProperty("orgGuid")),v("signed_query",m(n,t.auth.userGuid,s,t.auth.apiKey,i));return}if(r instanceof Function)return r(n,function(e){v("signed_query",e)});if(typeof r=="string")return e.post(r,JSON.stringify(n),function(e){v("signed_query",e)},"json")}v("query",n)}function v(n,r){r.requestId=o,e.cometd.publish("/service/"+n,r),i&&i.hasOwnProperty("start")&&typeof i.start=="function"&&i.start(),c=setTimeout(function(){u||b({data:{errorType:"TIMEOUT",data:"Timed out."}})},t.timeout*1e3)}function m(e,t,n,r,i){var s={queryJson:JSON.stringify(e),expiresAt:(new Date).getTime()+i*1e3,userGuid:t,orgGuid:n},o=s.queryJson+":"+s.userGuid+(s.orgGuid=="00000000-0000-0000-0000-000000000000"?"":":"+s.orgGuid)+":"+s.expiresAt;return s.digest=CryptoJS.HmacSHA1(o,CryptoJS.enc.Base64.parse(r)).toString(CryptoJS.enc.Base64),s}function g(e){var t=e.data;u=!1,t.type=="INIT"?f=!0:t.type=="START"?h.started++:t.type=="SPAWN"?(h.queued++,w()):t.type=="STOP"?(f?f=!1:(h.completed++,w()),u=h.queued==h.completed):t.type=="MESSAGE"?(a++,t.data.hasOwnProperty("errorType")?y(t):E(t)):t.type=="UNAUTH"?(b(t),u=!0):t.type=="ERROR"&&(b(t),u=!0),i&&i.hasOwnProperty("message")&&typeof i.message=="function"&&i.message(t),u&&S()}function y(e){i&&i.hasOwnProperty("warning")&&typeof i.warning=="function"&&i.warning(e.data.errorType,e.data.error)}function b(e){r.reject(e.data.errorType,e.data.data)}function w(){var e=0;h.queued>0&&(e=Math.round(h.completed/h.queued*100)),r.notify(e,h.completed,h.queued)}function E(e){var t=e.data.results;for(var n in t)t[n]={data:t[n],connectorGuid:e.connectorGuid,connectorVersionGuid:e.connectorVersionGuid,pageUrl:e.data.pageUrl,cookies:e.data.cookies,offset:e.data.offset};l=l.concat(t),i&&i.hasOwnProperty("data")&&typeof i.data=="function"&&i.data(t)}function S(){c&&clearTimeout(c),r.resolve(l),s(o)}var o=(new Date).getTime()+Math.random()*1e19,u=!1,a=0,f=!1,l=[],c=!1,h={queued:0,started:0,completed:0};return{receive:g,getId:p,start:d}},n=!1,r=!1,i={started:!1,connected:!1,wasConnected:!1,disconnecting:!1,callbacks:{established:function(){h({channel:"/meta",data:{type:"CONNECTION_ESTABLISHED"}})},broken:function(){h({channel:"/meta",data:{type:"CONNECTION_BROKEN"}})},closed:function(e){var t=e?"MULTIPLE_CLIENTS":"UNKNOWN";h({channel:"/meta",data:{type:"CONNECTION_CLOSED",reason:t}})},connected:function(){h({channel:"/meta",data:{type:"CONNECTED"}})},connect:g,handshake:function(t){t.successful&&(e.cometd.subscribe("/messaging",function(t){var n=s[t.data.requestId];if(!n){h({channel:"/meta",data:{type:"NO_QUERY",id:t.data.requestId}});return}n.receive(t)}),h({channel:"/meta",data:{type:"SUBSCRIBED"}}))}}},s={},o={host:"import.io",hostPrefix:"",randomHost:!0,port:!1,logging:!1,https:!0,connectionCallbacks:[v],timeout:60},u={};for(var a in o)u[a]=o[a];var f=[],l=!1,h=function(e){for(var t=0;t<u.connectionCallbacks.length;t++)try{u.connectionCallbacks[t](e)}catch(n){v("Error calling callback "+n)}},O={changepassword:function(t,n){return e.ajax(C("/auth/change-password"),{type:"POST",data:{oldpassword:t,newpassword:n}})},currentuser:function(){return k("GET","/auth/currentuser")},login:function(t,n){return e.ajax(C("/auth/login"),{type:"POST",data:{username:t,password:n},dataType:"json"})},logout:function(){return k("POST","/auth/logout")},apikey:{get:function(e){return k("POST","/auth/apikeyadmin",{password:e,overwrite:!1},!0)},create:function(t){return e.ajax(C("/auth/apikeyadmin"),{type:"POST",data:{password:t},dataType:"json"})}}};return{init:w,query:S,getDefaultConfiguration:x,getConfiguration:T,bucket:A,auth:O,addConnectionCallback:E,getEndpoint:C,setConfigurationProperty:N}}(jQuery),ioAngularAvailable={}.hasOwnProperty.call(window,"angular");if(ioAngularAvailable)var io=angular.module("importio",[]);ioAngularAvailable&&io.factory("ioapi",["$rootScope",function(e){return{bucket:importio.bucket,getEndpoint:importio.getEndpoint}}]),ioAngularAvailable&&io.factory("ioauth",["$rootScope",function(e){return{auth:importio.auth}}]),ioAngularAvailable&&io.factory("ioconfig",["$rootScope",function(e){return{addConnectionCallback:importio.addConnectionCallback,getConfiguration:importio.getConfiguration,getDefaultConfiguration:importio.getDefaultConfiguration,init:importio.init}}]),ioAngularAvailable&&io.factory("ioconnection",["$rootScope",function(e){var t=!0,n=!1;window.addEventListener("beforeunload",function(){n=!0});var r=function(){e.$broadcast("ioconnectionchange",t),t?e.$broadcast("ioconnected"):n||e.$broadcast("iodisconnected"),n=!1};return importio.addConnectionCallback(function(e){var n=!1;switch(e.data.type){case"CONNECTED":t||(n=!0),t=!0;break;case"CONNECTION_BROKEN":case"CONNECTION_CLOSED":t&&(n=!0),t=!1}n&&r()}),{connected:function(){return t}}}]),ioAngularAvailable&&io.factory("ioquery",["$rootScope",function(e){return{query:importio.query}}]);